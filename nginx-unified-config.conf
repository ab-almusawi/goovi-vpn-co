# ==============================================================================
# UNIFIED NGINX CONFIGURATION FOR GOOVI VPN
# Combines website (goovi-vpn.com) and VPN Backend API (IP access)
# ==============================================================================

# ------------------------------------------------------------------------------
# SERVER BLOCK 1: Domain-based Website (HTTP) - goovi-vpn.com
# ------------------------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name goovi-vpn.com www.goovi-vpn.com;

    # Allow Certbot for SSL certificate generation
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Downloads - static file serving
    location /downloads {
        alias /var/www/goovi-website/downloads;
        autoindex off;
        add_header Content-Disposition "attachment";
        add_header Cache-Control "public, max-age=86400";
    }

    # Next.js Website (serves on HTTP until SSL is configured)
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # VPN API endpoints
    location /api {
        proxy_pass http://localhost:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;

        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # Optimize static files
    location /_next/static {
        proxy_pass http://localhost:3001;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }

    # Optimize images
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        proxy_pass http://localhost:3001;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Logs
    access_log /var/log/nginx/goovi-vpn-access.log;
    error_log /var/log/nginx/goovi-vpn-error.log;
}

# ------------------------------------------------------------------------------
# SERVER BLOCK 2: HTTPS (DISABLED until SSL certificates are generated)
# After running certbot, uncomment this block
# ------------------------------------------------------------------------------
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name goovi-vpn.com www.goovi-vpn.com;
#
#     # SSL Configuration (auto-configured by Certbot)
#     ssl_certificate /etc/letsencrypt/live/goovi-vpn.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/goovi-vpn.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # Security headers
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     # Downloads - static file serving
#     location /downloads {
#         alias /var/www/goovi-website/downloads;
#         autoindex off;
#         add_header Content-Disposition "attachment";
#         add_header Cache-Control "public, max-age=86400";
#     }
#
#     # Next.js Website
#     location / {
#         proxy_pass http://localhost:3001;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         proxy_buffering off;
#         proxy_read_timeout 60s;
#         proxy_connect_timeout 60s;
#     }
#
#     # VPN API endpoints
#     location /api {
#         proxy_pass http://localhost:3000/api;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_read_timeout 300s;
#         proxy_connect_timeout 75s;
#
#         # CORS headers
#         add_header Access-Control-Allow-Origin * always;
#         add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
#         add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
#
#         if ($request_method = 'OPTIONS') {
#             return 204;
#         }
#     }
#
#     # Optimize static files
#     location /_next/static {
#         proxy_pass http://localhost:3001;
#         proxy_cache_valid 200 60m;
#         add_header Cache-Control "public, max-age=3600, immutable";
#     }
#
#     # Optimize images
#     location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
#         proxy_pass http://localhost:3001;
#         expires 1y;
#         add_header Cache-Control "public, max-age=31536000, immutable";
#     }
#
#     # Logs
#     access_log /var/log/nginx/goovi-vpn-https-access.log;
#     error_log /var/log/nginx/goovi-vpn-https-error.log;
# }

# ------------------------------------------------------------------------------
# SERVER BLOCK 3: VPN Backend API - Direct IP Access (for VPN clients)
# Handles: Server IP, Internal VPN IP, localhost
# ------------------------------------------------------------------------------
server {
    listen 80;
    listen 172.16.0.1:80;  # Internal VPN network IP
    server_name 81.30.161.139 172.16.0.1 localhost;

    # VPN API endpoints
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # CORS headers for API clients
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # Status endpoint for non-API requests
    location / {
        return 200 '{"service":"Goovi VPN API","status":"running","version":"1.0.0","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # Logs
    access_log /var/log/nginx/vpn-backend-access.log;
    error_log /var/log/nginx/vpn-backend-error.log;
}

# ==============================================================================
# DEPLOYMENT INSTRUCTIONS:
# ==============================================================================
# 1. Copy this file to nginx sites-available:
#    sudo cp nginx-unified-config.conf /etc/nginx/sites-available/goovi-vpn
#
# 2. Remove old symlinks:
#    sudo rm /etc/nginx/sites-enabled/goovi-vpn
#    sudo rm /etc/nginx/sites-enabled/vpn-backend
#
# 3. Create new symlink:
#    sudo ln -s /etc/nginx/sites-available/goovi-vpn /etc/nginx/sites-enabled/
#
# 4. Test configuration:
#    sudo nginx -t
#
# 5. Reload nginx:
#    sudo systemctl reload nginx
#
# 6. Generate SSL certificate (Certbot will auto-configure HTTPS):
#    sudo certbot --nginx -d goovi-vpn.com -d www.goovi-vpn.com
#
# 7. After SSL is generated, uncomment SERVER BLOCK 2 (HTTPS) and:
#    - Comment out or modify SERVER BLOCK 1 to redirect HTTP to HTTPS
#    - Test and reload nginx again
# ==============================================================================
